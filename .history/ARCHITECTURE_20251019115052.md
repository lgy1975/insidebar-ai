# 项目架构说明（Architecture）

## 项目概览

项目名：insidebar-ai

这是一个浏览器扩展（Chrome / Chromium / Firefox 兼容）的工具，旨在在网页或侧边栏内注入与管理 AI 提示（prompts）、提取与保存不同 AI 服务（如 ChatGPT、Claude、Gemini、Perplexity、DeepSeek、Grok 等）的会话/历史/页面内容，并提供侧边栏 UI、选项页与后台服务。

## 主要目录与文件

- `manifest.json`
  - 扩展的清单文件（权限、入口脚本、界面声明等）。

- `_locales/`
  - 多语言支持，包含若干语言的 `messages.json`，用于本地化字符串。

- `background/`
  - `service-worker.js`：扩展的后台脚本（service worker），处理后台事件、消息分发与持久化。

- `content-scripts/`
  - 针对不同 AI 服务的 extractor、enter-behavior 与 save-button 样式脚本。
  - 例如：`chatgpt-history-extractor.js`、`gemini-history-extractor.js`、`perplexity-history-extractor.js` 等。
  - `text-injection-*` 系列用于将 prompts 注入到目标输入框。

- `modules/`
  - 功能模块集合：`history-manager.js`、`prompt-manager.js`、`text-injector.js`、`providers.js`、`messaging.js`、`settings.js`、`i18n.js`、`url-validator.js`、`version-checker.js`、`html-utils.js`、`theme-manager.js` 等。

- `sidebar/`
  - 侧边栏 UI：`sidebar.html`、`sidebar.css`、`sidebar.js`、以及 `marked.min.js`（用于 Markdown 渲染）。

- `options/`
  - 扩展设置页：`options.html`、`options.css`、`options.js`。

- `data/`
  - 内置数据：`version-info.json`、`prompt-libraries/`（包含 `default-prompts.json`、`three-samples.json` 等）。

- `icons/`
  - 图标资源与使用指南（`ICON_GUIDE.md`）。

- `libs/`
  - 第三方库，例如 `Readability.js`（用于页面正文提取）。

- `rules/`
  - 配置规则文件，例如 `bypass-headers.json`。

- `tests/`
  - 单元测试（基于 vitest）：`html-utils.test.js`、`messaging.test.js`、`prompt-manager.test.js`、`providers.test.js`、`settings.test.js`、`text-injector.test.js`、`url-validator.test.js`。

- 顶层文件：`package.json`、`README.md`、`CHANGELOG.md`、`LICENSE`。

## 功能与数据流

- content scripts 注入到特定 AI 服务页面，使用 extractor 抓取对话内容或注入保存按钮/交互控件。
- 当用户触发保存、注入等操作时，content script 通过 `messaging.js` 与 `service-worker.js` 通信，后台负责持久化、同步或版本检查。
- `prompt-manager.js` 管理 prompt 库（内置 + 用户自定义），支持导入/导出/分类/搜索。
- 侧边栏（`sidebar.js`）提供 UI，允许用户查看/编辑 prompts、历史，并调用 `text-injector.js` 将选中文本注入页面输入框。
- `history-manager.js` 管理抓取到的对话历史，支持去重与元数据存储。

## 关键入口与执行路径

- `manifest.json` 注册 `service-worker.js` 与 content scripts。
- 浏览到支持的服务页面时，浏览器注入对应的 `content-scripts/*`。
- 侧边栏页面加载后与 `service-worker.js` 建立消息通道以读写数据。
- Options 页面用于配置用户偏好并调用模块化逻辑。

## 权限与安全要点

- 典型权限：host permissions（匹配 provider 域名）、storage、activeTab / scripting、可选远程请求权限。
- 注意数据隐私：历史导出/上传需在 UI 中明确告知用户。
- DOM 抓取需考虑懒加载、shadow DOM 与不同页面版本。

## 开发与调试建议

- 本地加载扩展：Chrome/Edge 扩展管理页 -> 加载已解压的扩展 -> 选择项目根目录。
- 依赖安装与测试（PowerShell 示例）：

```powershell
npm install
npm test
```

- 调试要点：调试 content scripts 的 selector、消息通道、prompt 导入/导出流程。

## 测试覆盖与质量

- 仓库包含多模块单元测试，已覆盖 `html-utils`、`messaging`、`prompt-manager` 等核心模块。建议运行 `vitest` 查看当前用例通过率并补充边缘情况测试。

## 可改进项（建议）

- 增加 CI（GitHub Actions）在 PR 时运行 lint、测试与构建。
- 部分关键模块迁移到 TypeScript 以增强类型安全。
- 增加 E2E 测试（Playwright）用于验证 content-scripts 在真实页面上的行为。
- 增强 extractor 的容错能力与 shadow DOM 支持。
- 在 README 或扩展设置中明确隐私/权限与数据导出策略。
- 增补开发文档：如何添加 provider、如何本地调试侧边栏与 content scripts、如何运行测试。

## 结语

如果你希望我把这份架构说明合并到 `README.md`（替换或追加），或者把改进项转换为 issues/PR 模板，我可以继续：

- 添加 `ARCHITECTURE.md`（已创建）并提交（若需要我可以帮你生成 git commit/PR）。
- 生成开发指南（`DEVELOPER.md`）或 CI 工作流文件（`.github/workflows/ci.yml`）。

请选择下一步或告诉我是否需要我提交一个 PR 来把这些文档或 CI 配置加入仓库。